---
title: "Run initial two-way ANOVAS"
subtitle: "Quasi Dark-Adapted Rapid Light Curve (RLC) Analysis"
author: "Sarah Tanja"
date: "`r format(Sys.time(), '%d %B, %Y')`"  
format:
  html:
    df-print: paged
    toc: true
    toc-location: right
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    code-fold: false
    code-tools: true
    code-copy: true
    highlight-style: breeze
    code-overflow: wrap
    theme: minty
editor: 
  markdown: 
    wrap: 72
---

# Overview

Here we take the cleaned up data from the quasi-dark adapted rapid light
curves and the dark-adapted quantum yield measurements and run some
initial anovas between treatments and visualize the data.

Repeated measures ANOVA resources: -
https://courses.washington.edu/psy524a/\_book/repeated-measures-anova.html#repeated-measures-with-more-than-two-levels

Generalized Linear Mixed Models (GLMM) resources:

Mixed Design Examples:
<https://courses.washington.edu/psy524a/_book/linear-mixed-models.html#using-lmer-for-a-repeated-measures-design:~:text=example%2C%20mixed%20designs%3A-,24.3%20Mixed%20Design%20Example%3A%20Effect%20of%20Napping%20and%20Time%20on%20Perceptual%20Performance,-A%20mixed%2Ddesign>

> This is a mixed design: The experiment has one within-subjects factor
> and two between-subjects factors. The days of exposure are the
> within-subjects factor (each anemones was measured four times), and
> the leachate condition (control vs. low vs. high) and the temperature
> (ambient vs. hot) are the between-subjects factors.

# Install and load packages

```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("Matrix")
```

```{r}
# Install packages
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse')
if ("dplyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('dplyr')
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2')
if ("hrbrthemes" %in% rownames(installed.packages()) == 'FALSE') install.packages('hrbrthemes')
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4')
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest')
if ("Rmisc" %in% rownames(installed.packages()) == 'FALSE') install.packages('Rmisc')


# Load packages
library(dplyr)
library(tidyverse)
library(ggplot2)
library(hrbrthemes)
library(lme4)
library(lmerTest)
library(Rmisc)
```

# Pull in RLC regression variables data

reg stands for regression from Jasby & Platt 1979

```{r}
reg_day1 <- read_csv("../output/reg_day1.csv")
reg_day2 <- read_csv("../output/reg_day2.csv")
reg_day3 <- read_csv("../output/reg_day3.csv")
reg_day4 <- read_csv("../output/reg_day4.csv")
```

# Pull in Fv/Fm data

```{r}
fvfm_day1 <- read_csv("../output/fvfm_day1.csv")
fvfm_day2 <- read_csv("../output/fvfm_day2.csv")
fvfm_day3 <- read_csv("../output/fvfm_day3.csv")
fvfm_day4 <- read_csv("../output/fvfm_day4.csv")
```

# Fv/Fm

## Data peek

### Day 1

```{r}
FvFm_1 <- ggplot(fvfm_day1) +
  aes(x = treatment, y = FvFm, fill= leachate) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
   labs(
    title = "Day 1 of Exposure: Photosynthetic efficiency (Fv/Fm)",
    x = " ",
    y = "Photosynthetic efficiency (Fv/Fm)"
  )  
FvFm_1
```

### Day 2

```{r}
FvFm_2 <- ggplot(fvfm_day2) +
  aes(x = treatment, y = FvFm, fill= leachate) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
   labs(
    title = "Day 2 of Exposure: Photosynthetic efficiency (Fv/Fm)",
    x = " ",
    y = "Photosynthetic efficiency (Fv/Fm)"
  )  
FvFm_2
```

### Day 3

```{r}
FvFm_3 <- ggplot(fvfm_day3) +
  aes(x = treatment, y = FvFm, fill= leachate) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
   labs(
    title = "Day 3 of Exposure: Photosynthetic efficiency (Fv/Fm)",
    x = " ",
    y = "Photosynthetic efficiency (Fv/Fm)"
  )  
FvFm_3
```

### Day 4

```{r}
FvFm_4 <- ggplot(fvfm_day4) +
  aes(x = treatment, y = FvFm, fill= leachate) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
   labs(
    title = "Day 4 of Exposure: Photosynthetic efficiency (Fv/Fm)",
    x = " ",
    y = "Photosynthetic efficiency (Fv/Fm)"
  )  
FvFm_4
```

### Across Days

Remove the YII column from day 1...

```{r}
fvfm_day1 <- fvfm_day1 %>% select(!YII)
```

Bind rows with `rbind` so that data is in long format See
[here](https://courses.washington.edu/psy524a/_book/repeated-measures-anova.html#repeated-measures-with-more-than-two-levels:~:text=This%20data%20is%20stored%20in%20%E2%80%98long%20format%E2%80%99%2C%20where%20each%20row%20in%20the%20table%20corresponds%20to%20a%20different%20observation)
about long format data for lmer

```{r}
fvfm_alldays <- do.call(rbind, list(fvfm_day1, fvfm_day2, fvfm_day3, fvfm_day4))
```

```{r}
summary(fvfm_alldays)
```

## Data exploration

```{r}
# get the means and standard errors
fvfm.summary <- summarySE(fvfm_alldays, measurevar="FvFm", groupvars=c("leachate","temp","days_of_exposure"))

ggplot(fvfm.summary, aes(x=days_of_exposure, y=FvFm, colour = leachate, group = temp)) +
  geom_errorbar(aes(ymin=FvFm-se, ymax=FvFm+se), width=.2) +
  geom_line() +
  theme_bw() +
  geom_point(size = 5)
```

```{r}
# Create the boxplot
ggplot(fvfm_alldays, aes(x = treatment, y = FvFm, color = treatment)) +
  geom_boxplot() +
  facet_wrap(~ days_of_exposure) +
  theme_bw() +
  labs(
    title = "Photosynthetic efficiency (Fv/Fm) across Treatments and Days",
    x = "Treatment",
    y = "Photosynthetic efficiency (Fv/Fm)"
  ) + 
  theme (axis.text.x = element_blank())  # Remove x-axis labels
```

### Boxplots

#### Facetgrid

```{r}
# Create the boxplot
fvfm_byday <- ggplot(fvfm_alldays, aes(x = treatment, y = FvFm, color = treatment)) +
  geom_boxplot() +
  facet_grid(. ~ days_of_exposure, switch = "x") +
  theme_bw() +
  labs(
    title = "Photosynthetic efficiency (Fv/Fm) across Treatments and Days of Exposure",
    x = "Days of Exposure",
    y = "Photosynthetic efficiency (Fv/Fm)"
  ) +
  theme(axis.text.x = element_blank())  # Remove x-axis labels

fvfm_byday

# save the plot as a .png
ggsave("../output/fvfm_byday_plot.png", plot = fvfm_byday, width = 10, height = 6, dpi = 600)
```

```{r}
# Create the boxplot
fvfm_byday_treatment <- ggplot(fvfm_alldays, aes(x = as.factor(treatment), y = FvFm, color = as.factor(days_of_exposure))) +
  geom_boxplot() +
  facet_grid(. ~ treatment, switch = "x", scales = "free_x") +
  theme_bw() +
  labs(
    title = "Photosynthetic efficiency (Fv/Fm) across Treatments and Days of Exposure",
    x = "Treatment",
    y = "Photosynthetic efficiency (Fv/Fm)"
  ) +
  theme(axis.text.x = element_blank(), # remove x-axis labels
    strip.text = element_text(size = 6)  # adjust facet label size
  )  

fvfm_byday_treatment

# save the plot as a .png
ggsave("../output/fvfm_byday_treatment_plot.png", plot = fvfm_byday_treatment, width = 10, height = 6, dpi = 600)
```

```{r}
# Create the boxplot
fvfm_byday_treatment <- ggplot(fvfm_alldays, aes(x = as.factor(days_of_exposure), y = FvFm, fill = as.factor(days_of_exposure))) +
  geom_boxplot() +
  facet_wrap(~ treatment, scales = "free_x") +
  theme_bw() +
  labs(
    title = "Photosynthetic efficiency (Fv/Fm) across Treatments and Days of Exposure",
    x = "Days of Exposure",
    y = "Photosynthetic efficiency (Fv/Fm)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Adjust x-axis labels for readability
    strip.text = element_text(size = 12)  # Optional: adjust facet label size
  )

fvfm_byday_treatment
```

#### Combined x-axis

```{r}

# Create a new column combining days_of_exposure and treatment
fvfm_alldays$day_treatment <- interaction(fvfm_alldays$days_of_exposure, fvfm_alldays$treatment)

# Create the boxplot
fvfm_combo <- ggplot(fvfm_alldays, aes(x = day_treatment, y = FvFm, fill = leachate, color = temp)) +
  geom_boxplot() +
  theme_bw() +
  labs(
    title = "Photosynthetic efficiency (Fv/Fm) across Treatments and Days",
    x = "Days of Exposure and Treatment",
    y = "Photosynthetic efficiency (Fv/Fm)"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

fvfm_combo

# save the plot as a .png
ggsave("../output/fvfm_combo_plot.png", plot = fvfm_combo, width = 10, height = 6, dpi = 600)

```

## ANOVA \| one-way, each day

### Day 1

```{r}
fvfm_aov_1 <- aov(FvFm ~ treatment,
  data = fvfm_day1
)

summary(fvfm_aov_1)
```

### Day 2

```{r}
fvfm_aov_2 <- aov(FvFm ~ treatment,
  data = fvfm_day2
)

summary(fvfm_aov_2)
```

### Day 3

```{r}
fvfm_aov_3 <- aov(FvFm ~ treatment,
  data = fvfm_day3
)

summary(fvfm_aov_3)
```

### Day 4

```{r}
fvfm_aov_4 <- aov(FvFm ~ treatment,
  data = fvfm_day4
)

summary(fvfm_aov_4)
```

## Across Days

### (GLMM)

```{r}
lmer.fvfm <- lmer(FvFm ~ leachate*temp*days_of_exposure + (1|sample_id), data=fvfm_alldays)

anova(lmer.fvfm)
```

### (multiple measures ANOVA)

# Alpha

Bind regression variables (alpha, rETRm, Ik) dataset to long-form

```{r}
reg_alldays <- do.call(rbind, list(reg_day1, reg_day2, reg_day3, reg_day4))

summary(reg_alldays)
```

### Boxplots

```{r}

# Create a new column combining days_of_exposure and treatment
reg_alldays$day_treatment <- interaction(reg_alldays$days_of_exposure, reg_alldays$treatment)

# Create the boxplot
alpha_combo <- ggplot(reg_alldays, aes(x = day_treatment, y = alpha, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  labs(
    title = "Alpha (a) across Treatments and Days",
    x = "Days of Exposure and Treatment",
    y = "Alpha (a)"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

alpha_combo

# save the plot as a .png
ggsave("../output/alpha_combo_plot.png", plot = alpha_combo, width = 10, height = 6, dpi = 600)
```

# Saturating Irradiance (Ek/Ik)

## Boxplots

```{r}
# Create the boxplot
Ik_combo <- ggplot(reg_alldays, aes(x = day_treatment, y = Ik, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  labs(
    title = "Saturating Irradiance (Ik) across Treatments and Days",
    x = "Days of Exposure and Treatment",
    y = "Saturating Irradiance (Ik)"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

Ik_combo

# save the plot as a .png
ggsave("../output/Ik_combo_plot.png", plot = Ik_combo, width = 10, height = 6, dpi = 600)
```

# rETR~max~

## Boxplots

```{r}
# Create the boxplot
rETRm_combo <- ggplot(reg_alldays, aes(x = day_treatment, y = ETRm, color = treatment)) +
  geom_boxplot() +
  theme_bw() +
  labs(
    title = "rETRmax across Treatments and Days",
    x = "Days of Exposure and Treatment",
    y = "rETRmax"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rETRm_combo

# save the plot as a .png
ggsave("../output/rETRm_combo_plot.png", plot = rETRm_combo, width = 10, height = 6, dpi = 600)
```
